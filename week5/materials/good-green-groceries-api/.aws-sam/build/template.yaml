AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::Serverless-2016-10-31
Parameters:
  ProductsTableName:
    Type: String
    Default: products-malek-table
  SubscriptionsTableName:
    Type: String
    Default: subscriptions-malek-table
Globals:
  Function:
    Runtime: nodejs14.x
    MemorySize: 128
    Timeout: 100
  Api:
    Cors:
      AllowHeaders: '''*'''
      AllowMethods: '''*'''
      AllowOrigin: '''*'''
      MaxAge: '''*'''
Resources:
  productsFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/products.productsHandler
      Description: A simple example includes a HTTP get method to get all items from
        a DynamoDB table.
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: ProductsTable
      Environment:
        Variables:
          PRODUCTS_TABLE:
            Ref: ProductsTable
      Events:
        ApiGet:
          Type: Api
          Properties:
            Path: /products
            Method: GET
            RestApiId:
              Ref: MyAPI
        ApiPost:
          Type: Api
          Properties:
            Path: /products
            Method: POST
            RestApiId:
              Ref: MyAPI
        ApiPut:
          Type: Api
          Properties:
            Path: /products
            Method: PUT
            RestApiId:
              Ref: MyAPI
      CodeUri: productsFunction
  subscriptionsFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/subscriptions.subscriptionsHandler
      Description: A simple example includes a HTTP post method to post all items
        to a DynamoDB table.
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: SubscriptionsTable
      Environment:
        Variables:
          SUBSCRIPTIONS_TABLE:
            Ref: SubscriptionsTable
      Events:
        Api1:
          Type: Api
          Properties:
            Path: /subscriptions
            Method: GET
            RestApiId:
              Ref: MyAPI
        Api2:
          Type: Api
          Properties:
            Path: /subscriptions
            Method: PUT
            RestApiId:
              Ref: MyAPI
        Api3:
          Type: Api
          Properties:
            Path: /subscriptions
            Method: POST
            RestApiId:
              Ref: MyAPI
      CodeUri: subscriptionsFunction
  ProductsTable:
    Type: AWS::Serverless::SimpleTable
    Properties:
      TableName:
        Ref: ProductsTableName
      PrimaryKey:
        Name: id
        Type: String
  SubscriptionsTable:
    Type: AWS::Serverless::SimpleTable
    Properties:
      TableName:
        Ref: SubscriptionsTableName
      PrimaryKey:
        Name: id
        Type: String
  MyAPI:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
Outputs:
  WebEndpoint:
    Description: API Gateway endpoint URL for Prod stage
    Value:
      Fn::Sub: https://${MyAPI}.execute-api.${AWS::Region}.amazonaws.com/Prod/
